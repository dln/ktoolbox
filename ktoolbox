#!/bin/bash
set -e
name=toolbox-${USER}
image='dlneintr/toolbox:latest'

old=$(kubectl get pod --field-selector=status.phase!=Running -l name=${name} --output='jsonpath={.items..metadata.name}')
if [ "${old}" != "" ]; then
  kubectl delete pod --grace-period=0 ${name}
fi

kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: ${name}
  labels:
    app: ktoolbox
    name: ${name}
spec:
  restartPolicy: Never
  terminationGracePeriodSeconds: 1
  containers:
  - image: ${image}
    imagePullPolicy: Always
    name: toolbox
    lifecycle:
      preStop:
        exec:
          command: ['/usr/bin/curl', '-X', 'POST', 'http://127.0.0.1:15020/quitquitquit']
EOF

for i in {1..10}; do
  ready=$(kubectl get pod --field-selector=status.phase=Running -l name=${name} --output='jsonpath={.items..metadata.name}')
  if [ "${ready}" != "" ]; then
    exec kubectl exec -it -c toolbox ${ready} /bin/bash
  fi
  echo "Waiting for pod to be ready"
  sleep 1
done
